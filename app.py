import streamlit as st
import pandas as pd
import numpy as np
import plotly.graph_objects as go
from datetime import datetime, timedelta

# ---------------------------------------------------------
# è¨­å®šãƒ»åˆæœŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
# ---------------------------------------------------------
st.set_page_config(page_title="çŸ­æœŸäºˆæ¸¬AI", layout="wide")

# ç¾åœ¨ã®åŸºæº–ä¾¡æ ¼ï¼ˆæ‰‹å‹•å…¥åŠ›ã¾ãŸã¯APIå–å¾—ã®æƒ³å®šï¼‰
# å®Ÿéš›ã®ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆã«åˆã‚ã›ã¦èª¿æ•´ã—ã¦ãã ã•ã„
current_price_input = 156.92 

# ---------------------------------------------------------
# é–¢æ•°å®šç¾©
# ---------------------------------------------------------

def calculate_probabilities(current_price):
    """
    ç¾åœ¨å€¤ã¨äºˆæ¸¬å€¤ã®ä¹–é›¢ã«åŸºã¥ã„ã¦ç¢ºç‡ã‚’è¨ˆç®—ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯
    """
    # äºˆæ¸¬ãƒ¢ãƒ‡ãƒ«ï¼ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ï¼‰
    # å®Ÿéš›ã¯ã“ã“ã«æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã®æ¨è«–ãŒå…¥ã‚Šã¾ã™
    # ä»Šå›ã¯ç•°å¸¸å€¤ãŒå‡ºãªã„ã‚ˆã†ã€ç¾å®Ÿçš„ãªãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ã§è¨ˆç®—ã—ã¾ã™
    time_frames = [1, 2, 4, 8, 12]
    
    data = []
    
    for h in time_frames:
        # ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®äºˆæ¸¬ãƒ¬ãƒ¼ãƒˆç”Ÿæˆ (å°‘ã—ãšã¤ä¸Šæ˜‡ã™ã‚‹ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’ä»®å®š)
        # 1æ™‚é–“ã”ã¨ã«0.05å††ã€œ0.10å††ç¨‹åº¦ã®å¤‰å‹•å¹…ã‚’æŒãŸã›ã‚‹
        predicted_price = current_price + (0.05 * h)
        
        # ä¹–é›¢é¡ï¼ˆäºˆæ¸¬ - ç¾åœ¨ï¼‰
        diff = predicted_price - current_price
        
        # ä¹–é›¢ç‡ (%) 
        deviation_pct = (diff / current_price) * 100
        
        # ç¢ºç‡è¨ˆç®—ï¼ˆãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯é–¢æ•°çš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼‰
        # scaling_factor: æ„Ÿåº¦èª¿æ•´ä¿‚æ•°ã€‚å€¤ãŒå¤§ãã„ã»ã©ç¢ºç‡ãŒæ•æ„Ÿã«å¤‰åŒ–ã™ã‚‹ã€‚
        # ç‚ºæ›¿ã®ã‚ˆã†ãªä½ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£è³‡ç”£ã§ã¯ã€å°ã•ãªå·®ã‚’éå¤§è©•ä¾¡ã—ãªã„ã‚ˆã†èª¿æ•´ãŒå¿…è¦ã€‚
        scaling_factor = 2.0  # ã“ã‚Œã‚’å¤§ããã—ã™ãã‚‹ã¨99%ã«å¼µã‚Šä»˜ãã¾ã™
        
        # ã‚·ã‚°ãƒ¢ã‚¤ãƒ‰é–¢æ•°ã§ç¢ºç‡ã‚’0.5(50%)ä¸­å¿ƒã«è¨ˆç®—
        # ä¹–é›¢0ãªã‚‰50%ã€‚ãƒ—ãƒ©ã‚¹ä¹–é›¢ãªã‚‰50%è¶…ã€‚
        up_prob = 1 / (1 + np.exp(-diff * scaling_factor))
        
        # ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆè¡¨è¨˜ã¸å¤‰æ›
        up_prob_pct = up_prob * 100
        down_prob_pct = 100 - up_prob_pct
        
        # åˆ¤å®šã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆ
        if deviation_pct > 0.05:
            status = f"âš ï¸ ä¸‹æŒ¯ã‚Œä¹–é›¢ (åç™ºæœŸå¾… +{deviation_pct:.3f}%)"
            color = "green" # ä¸Šæ˜‡æœŸå¾…
        elif deviation_pct < -0.05:
            status = f"âš ï¸ ä¸ŠæŒ¯ã‚Œä¹–é›¢ (åè½è­¦æˆ’ {deviation_pct:.3f}%)"
            color = "red"   # ä¸‹è½è­¦æˆ’
        else:
            status = "ãƒ¬ãƒ³ã‚¸å†… (ä¸­ç«‹)"
            color = "gray"

        data.append({
            "æ™‚é–“": f"{h}Hå¾Œ",
            "äºˆæ¸¬ãƒ¬ãƒ¼ãƒˆ": predicted_price,
            "ä¸Šæ˜‡ç¢ºç‡": up_prob_pct,
            "ä¸‹è½ç¢ºç‡": down_prob_pct,
            "åˆ¤å®š/çŠ¶æ³": status,
            "color": color # ã‚°ãƒ©ãƒ•ç”¨ã‚«ãƒ©ãƒ¼ã‚¿ã‚°
        })
        
    return pd.DataFrame(data)

# ---------------------------------------------------------
# ãƒ¡ã‚¤ãƒ³å‡¦ç†
# ---------------------------------------------------------

st.title(f"ç¾åœ¨å€¤: {current_price_input:.2f} å††")
st.caption(f"åŸºæº–æ—¥æ™‚: {datetime.now().strftime('%m/%d %H:%M')}")

# ãƒ‡ãƒ¼ã‚¿è¨ˆç®—
df = calculate_probabilities(current_price_input)

# --- ã‚°ãƒ©ãƒ•æç”» (Plotlyã‚’ä½¿ç”¨) ---
st.subheader("ğŸ“ˆ çŸ­æœŸäºˆæ¸¬ (ä¸Šæ˜‡ vs ä¸‹è½)")

fig = go.Figure()

# ä¸Šæ˜‡ç¢ºç‡ã®ãƒãƒ¼ï¼ˆç·‘ï¼‰
fig.add_trace(go.Bar(
    x=df["æ™‚é–“"],
    y=df["ä¸Šæ˜‡ç¢ºç‡"],
    name='ä¸Šæ˜‡ç¢ºç‡',
    marker_color='#00CC96', # æ˜ã‚‹ã„ç·‘
    text=df["ä¸Šæ˜‡ç¢ºç‡"].apply(lambda x: f"{x:.1f}%"),
    textposition='auto'
))

# ä¸‹è½ç¢ºç‡ã®ãƒãƒ¼ï¼ˆèµ¤ï¼‰
# ç©ã¿ä¸Šã’ã«ã™ã‚‹ã‹ã€ä¸¦åˆ—ã«ã™ã‚‹ã‹ã¯å¥½ã¿ã§ã™ãŒã€ä»Šå›ã¯ã€Œç¢ºç‡ã®æ”¯é…ç‡ã€ã‚’è¦‹ã‚‹ãŸã‚
# ä¸Šæ˜‡ç¢ºç‡ã®æ®‹ã‚Šã‚’å¯è¦–åŒ–ã™ã‚‹å½¢ã§ã¯ãªãã€ãã‚Œãã‚Œã®å‹¢ã„ã¨ã—ã¦è¡¨ç¾ã—ã¾ã™ã€‚
# â€»ã‚‚ã—ã€Œä¸Šæ˜‡+ä¸‹è½=100%ã€ã®ç©ã¿ä¸Šã’æ£’ã‚°ãƒ©ãƒ•ã«ã—ãŸã„å ´åˆã¯ barmode='stack' ã«ã—ã¾ã™ã€‚

# ã“ã“ã§ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ä¸Šæ˜‡ç¢ºç‡ã®é«˜ã•ã ã‘ã‚’å¼·èª¿è¡¨ç¤ºã™ã‚‹ã‚¹ã‚¿ã‚¤ãƒ«ã«ã—ã¾ã™ï¼ˆç”»åƒã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã«è¿‘ã„å½¢ï¼‰
# ã‚‚ã—ä¸‹è½ç¢ºç‡ã‚‚è¡¨ç¤ºã—ãŸã„å ´åˆã¯ä»¥ä¸‹ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆè§£é™¤ã—ã¦ãã ã•ã„
# fig.add_trace(go.Bar(
#     x=df["æ™‚é–“"],
#     y=df["ä¸‹è½ç¢ºç‡"],
#     name='ä¸‹è½ç¢ºç‡',
#     marker_color='#EF553B' # èµ¤
# ))

fig.update_layout(
    yaxis=dict(
        title="ç¢ºç‡ (%)",
        range=[0, 100] # 0-100%ã§å›ºå®š
    ),
    barmode='group',
    height=300,
    margin=dict(l=20, r=20, t=20, b=20),
)

st.plotly_chart(fig, use_container_width=True)

# --- è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º ---
st.subheader("è©³ç´°æ•°å€¤ & AIåˆ¤æ–­")

# è¡¨ç¤ºç”¨ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã®æ•´å½¢
display_df = df[["æ™‚é–“", "äºˆæ¸¬ãƒ¬ãƒ¼ãƒˆ", "ä¸Šæ˜‡ç¢ºç‡", "ä¸‹è½ç¢ºç‡", "åˆ¤å®š/çŠ¶æ³"]].copy()
display_df["äºˆæ¸¬ãƒ¬ãƒ¼ãƒˆ"] = display_df["äºˆæ¸¬ãƒ¬ãƒ¼ãƒˆ"].apply(lambda x: f"{x:.2f} å††")
display_df["ä¸Šæ˜‡ç¢ºç‡"] = display_df["ä¸Šæ˜‡ç¢ºç‡"].apply(lambda x: f"{x:.1f} %")
display_df["ä¸‹è½ç¢ºç‡"] = display_df["ä¸‹è½ç¢ºç‡"].apply(lambda x: f"{x:.1f} %")

st.table(display_df)
